---
title: "Working with multiple trials"
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(animovement)
```

# Approaches

When working with multiple trials, there are multiple ways of reading all the data whilst keeping track of all the important information. Here we'll cover a few ways that are supported by *trackballr*.

- **Match from file names**. *When to use*: File names contain enough information that can be used to distinguish between experiments.
- **Match from metadata file**. *When to use*: File names contain little or no information.

# Match from file names

***When to use***: File names contain enough information that can be used to distinguish between experiments.

**WORK IN PROGRESS!**

Want to make life a little easier for yourself? So do we. Keeping track of many files can be tricky, but if you are conscious of how you name your files, you can make life a lot easier for yourself!

There are two key elements for enabling automatic import:

1. Include enough metadata to identify the experiment
2. Name files to ensure pairing of files is possible

## Metadata in file name

*TL;DR* Include datetime in file name, reserve a character, e.g. `_` (underscore), for separating pieces of information.


- **GOOD**: `A101_2024-05-21T10-21-53`
- **BAD**: `A101_2024-05-21T10_21_53`

`ANIMALID_y-m-dT.csv`


# Match from metadata file

***When to use***: File names contain little or no information.

In this scenario we use a spreadsheet to keep track of which files go together. We have an `.xlsx` file that contains the correct pairs of file names. Let's begin by reading and inspecting the file.

```{r}
library(stringr)

# We start by finding the metadata file (this may look different for you as we're using the files provided by the package)
metadata_filename <- system.file("extdata/multi", package = "trackballr") |> 
  list.files(full.names = TRUE) |> 
  str_subset(pattern = "xlsx")

# And then we can read the metadata file
library(readxl)
library(tinytable)
metadata_files <- read_xlsx(metadata_filename)
tt(metadata_files)
```

We can then import our data one set after the other. We use the *here* package to make file management easier.

```{r}
library(tibble)
library(dplyr, warn.conflicts = FALSE)
library(here)
df <- tibble()

for (i in 1:nrow(metadata_files)){
  # Change the path to match your local file structure
  file_primary <- system.file("extdata/multi", package = "trackballr") |> 
    list.files(full.names = TRUE) |> 
    str_subset(metadata_files$filename_a[i])
  file_secondary <- system.file("extdata/multi", package = "trackballr") |> 
    list.files(full.names = TRUE) |> 
    str_subset(metadata_files$filename_b[i])
  
  # Then we'll read all the files
  df_temp <- read_trackball(
    filepaths = c(file_primary, file_secondary),
    configuration = "free",
    time_col = 4,
    sampling_rate = 60,
    mouse_dpcm = 394) |>
    mutate(# We add the identity and date to distinguish between experiments
      id = metadata_files$identity[i], 
      date = metadata_files$date[i])
  df <- bind_rows(df, df_temp)
}
```

**Congratulations, you now have all your data loaded in a single file!** You can now continue with the remaining steps of the workflow outlined in [..](), the only difference being that we need to remember to add `group_by(id, date)` to ensure that experiments are processed separately. 

```{r}
df_kinematics <- df |> 
  group_by(id, date) |> 
  smooth_track(method = "rolling_mean", window_width = 30) |> 
  compute_kinematics()
```


## Visualise it!

To finish this example, let's have some fun and try to plot some of our trials!

```{r}
library(ggplot2)
pl_direction <- df_kinematics |> 
  filter(v_translation > 0.2) |> 
  ggplot(aes(x = direction, y = v_translation)) + 
  stat_density_2d(
    geom = "tile", 
    aes(fill = after_stat(density)),
    n=c(40, 10), 
    contour = F
  ) + 
  scale_fill_viridis_c() +
  # scale_fill_gradientn(colours=rev(rainbow(32)[1:23])) + 
  coord_polar() +
  facet_grid(rows = vars(date)) +
  theme_minimal()

max_coord <- max(abs(c(df_kinematics$x, df_kinematics$y)), na.rm = TRUE)
pl_path <- df_kinematics |> 
  ggplot(aes(x, y, colour = v_translation)) +
  geom_path() +
  coord_fixed() +
  scale_x_continuous(limits = c(-max_coord, max_coord)) +
  scale_y_continuous(limits = c(-max_coord, max_coord)) +
  scale_colour_viridis_c() +
  facet_grid(rows = vars(date)) +
  theme_minimal()

library(patchwork)
pl_path + pl_direction +
  plot_layout(guides = "collect")
```
