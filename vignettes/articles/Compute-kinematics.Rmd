---
title: "Compute kinematics"
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(trackballr)
library(tibble)
library(dplyr, warn.conflicts = FALSE)
library(readxl)
library(here)
here::i_am("vignettes/articles/Compute-kinematics.Rmd")
```

```{r include=FALSE}
# Read metadata
metadata_path <- here("inst", "extdata", "multi", "trackball_filenames.xlsx")
metadata_file <- read_xlsx(metadata_path)

# First, we'll create an empty data frame which we'll read our data into
df <- tibble()

# Then we loop through the rows in the metadata file
for (i in 1:nrow(metadata_file)){
  
  # Like before, change the path to match your local file structure
  file_primary <- here("inst", "extdata", "multi", metadata_file$filename_a[i])
  file_secondary <- here("inst", "extdata", "multi", metadata_file$filename_b[i])
  
  # Then we'll read all the file
  df_temp <- read_trackball(
    filepaths = c(file_primary, file_secondary),
    configuration = "free",
    time_col = 4,
    sampling_rate = 60,
    mouse_dpcm = 394)
  
  # And we can add other metadata, such as the identity and date to distinguish between experiments
  df_temp <- df_temp |> 
    mutate(
      id = metadata_file$identity[i], 
      date = metadata_file$date[i])
  
  # Finally, we bind the data together
  df <- bind_rows(df, df_temp)
}

# Smooth tracks
df_smooth <- df |> 
  group_by(id, date) |> # We can use group_by with our metadata for a tidyverse-friendly workflow 
  smooth_track(method = "rolling_median", window_width = 5)
```

## Compute kinematics

When we work with movement data, we are often interested in more than just where an animal *is*; we're interested in how fast it moves, where it is heading etc. 
`compute_kinematics` computes a range of kinematic variables:

- `distance`: The distance the animal moved since the last observation (simply calculated using Pythagoras' theorem)
- `v_translation`: The translational velocity, like what you see on a speedometer in a car.
- `direction`: The direction (in radians) the animal is heading - where the arrow on the compass is heading.
- `rotation`: Difference from direction of the last observation.
- `v_rotation`: The rotational velocity (in rad/s).

```{r}
# Augment all data in list
df_kinematics <- df_smooth |> 
  group_by(id, date) |> 
  compute_kinematics()
glimpse(df_kinematics)
```

## Assess kinematics for outliers

Kinematics are much more prone to small values change. We assess these in two ways:

- **Visual inspection**
- **Outlier detection**

```{r}
library(patchwork)
a <- df_kinematics |> 
  ggplot(aes(x, y, colour = time)) +
  geom_path() +
  scale_colour_viridis_c()
b <- df_kinematics |> 
  ggplot(aes(time, direction)) +
  geom_line()
c <- df_kinematics |> 
  ggplot(aes(time, v_translation)) +
  geom_line()
d <- df_kinematics |> 
  filter(v_translation > 0) |> 
  ggplot(aes(time, v_rotation)) +
  geom_line()
e <- df_kinematics |> 
  ggplot(aes(abs(v_translation))) +
  geom_histogram()
f <- df_kinematics |> 
  ggplot(aes(abs(v_rotation))) +
  geom_histogram()
(a + b) / (c + d) / (e + f)

library(performance)
df_kinematics |> 
  na.omit() |> 
  select(rotation) |>
  performance::check_outliers()
```

